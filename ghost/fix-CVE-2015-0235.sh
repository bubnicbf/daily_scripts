#!/usr/bin/env bash

#script for fix CVE-2015-0235
# more info:
#   https://www.qualys.com/research/security-advisories/GHOST-CVE-2015-0235.txt
# el6 lib package:
#   http://lists.centos.org/pipermail/centos-announce/2015-January/020907.html
#   http://mirror.centos.org/centos/6.6/updates/x86_64/Packages/
#       glibc-devel-2.12-1.149.el6_6.5.x86_64.rpm
#       glibc-common-2.12-1.149.el6_6.5.x86_64.rpm
#       nscd-2.12-1.149.el6_6.5.x86_64.rpm
#       glibc-static-2.12-1.149.el6_6.5.x86_64.rpm
#       glibc-headers-2.12-1.149.el6_6.5.x86_64.rpm
#       glibc-utils-2.12-1.149.el6_6.5.x86_64.rpm
#       glibc-2.12-1.149.el6_6.5.x86_64.rpm
#       glibc-static-2.12-1.149.el6_6.5.i686.rpm
#       glibc-devel-2.12-1.149.el6_6.5.i686.rpm
#       glibc-2.12-1.149.el6_6.5.i686.rpm
#
# el5 lib package:
#   http://mirror.centos.org/centos/5/updates/x86_64/RPMS/?C=M;O=D
#   http://lists.centos.org/pipermail/centos-announce/2015-January/020906.html
#
export PS4='+ [`basename ${BASH_SOURCE[0]}`:$LINENO ${FUNCNAME[0]} \D{%F %T} $$ ] '

check_cve_2015_0235()
{
    rv=0

    for glibc_nvr in $( rpm -q --qf '%{name}-%{version}-%{release}.%{arch}\n' glibc ); do
        glibc_ver=$( echo "$glibc_nvr" | awk -F- '{ print $2 }' )
        glibc_maj=$( echo "$glibc_ver" | awk -F. '{ print $1 }')
        glibc_min=$( echo "$glibc_ver" | awk -F. '{ print $2 }')

        # echo -n "- $glibc_nvr: "
        if [ "$glibc_maj" -gt 2   -o  \
            \( "$glibc_maj" -eq 2  -a  "$glibc_min" -ge 18 \) ]; then
            # fixed upstream version
	    :
            #echo 'not vulnerable'
        else
            # all RHEL updates include CVE in rpm %changelog
            if rpm -q --changelog "$glibc_nvr" | grep -q 'CVE-2015-0235'; then
                #echo "not vulnerable"
		:
            else
                #echo "vulnerable"
                rv=1
            fi
        fi
    done

    echo $rv
}

function check_cve_2015_0235_c()
{
    if [ -f "./ghost" ]; then
        `./ghost`
        ret=$?
    fi

    echo $ret
}

ret=$(check_cve_2015_0235)
#ret=$(check_cve_2015_0235_c)
if [ $ret -ne 0 ]; then
    echo "Begin fix CVE-2015-0235......."
    #rpm -Uvh *.rpm
    yum localupdate *.rpm &> glibcupdate.log

    if [ $? -ne 0 ]; then
        echo "Fix CVE-2015-0235 failed when install patch."
	exit 1;
    fi
fi

ret=$(check_cve_2015_0235)
if [ $ret -ne 0 ]; then
   echo "FIX CVE-2015-0235 failed."
else
   echo "FIX CVE-2015-0235 successed."
fi

